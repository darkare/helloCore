name: Manual Deploy by Tag

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select target environment"
        required: true
        type: choice
        options:
          - uat
          - prod
      tag:
        description: "Git tag to deploy (e.g. v1.0.3)"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Automatically links to the selected GitHub Environment
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Display info
        run: |
          echo "Deploying tag: ${{ github.event.inputs.tag }}"
          echo "Target environment: ${{ github.event.inputs.environment }}"

      - name: Show environment variable from GitHub Environment
        run: |
          echo "ENV_NAME for ${{ github.event.inputs.environment }}: ${{ vars.ENV_NAME }}"

      - name: Deploy
        run: |
          if [ "${{ github.event.inputs.environment }}" = "uat" ]; then
            echo "âœ… Deploying to UAT..."
            # your UAT deploy logic here
          elif [ "${{ github.event.inputs.environment }}" = "prod" ]; then
            echo "ðŸš€ Deploying to PRODUCTION..."
            # your PROD deploy logic here
          fi
          
      - name: Update GitHub Release notes with deployment info
        if: ${{ github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'uat' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ github.event.inputs.tag }}
          ENV=${{ github.event.inputs.environment }}
          NOW=$(date -u +"%Y-%m-%d %H:%M:%SZ")
      
          # ensure gh and jq are installed
          sudo apt-get update -qq
          sudo apt-get install -y jq gh > /dev/null
      
          # get the release details
          release_json=$(gh api repos/${{ github.repository }}/releases/tags/$TAG)
          release_id=$(echo "$release_json" | jq -r .id)
          current_body=$(echo "$release_json" | jq -r .body)
      
          # create a nicely formatted entry
          new_entry=$(cat <<EOF
      
          ### ðŸŸ¢ Deployment Record
          - **Environment:** ${ENV^^}
          - **Date:** ${NOW}
          - **Triggered by:** $GITHUB_ACTOR
          - **Workflow Run:** [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          
          EOF
          )
          
          # combine and update release body
          updated_body="${current_body}${new_entry}"
      
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/releases/$release_id \
            -f body="$updated_body"
      
          echo "âœ… Release $TAG updated with ${ENV^^} deployment record"
            