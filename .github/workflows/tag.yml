name: Manual Deploy by Tag

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select the target environment"
        required: true
        type: choice
        options:
          - uat
          - prod
      tag:
        description: "Git tag to deploy (e.g. v1.0.3)"
        required: true
        type: string

jobs:
  # UAT deployment (no approval required)
  deploy-uat:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'uat'
    environment: uat

    steps:
      - name: Checkout code for the given tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Display deployment context
        run: |
          echo "Selected environment: uat"
          echo "Tag to deploy: ${{ github.event.inputs.tag }}"

      # Retrieve ENV_NAME variable configured in GitHub Environment
      - name: Show environment variable from GitHub Environment
        run: |
          echo "ENV_NAME from uat environment is: ${{ vars.ENV_NAME }}"

      - name: Deploy to UAT
        run: |
          echo "Deploying ${{ github.event.inputs.tag }} to UAT environment..."
          # Add your UAT deployment commands here

  # Production deployment (requires approval)
  deploy-prod:
    runs-on: ubuntu-latest
    if: github.event.inputs.environment == 'prod'
    environment: 
      name: prod
      url: https://your-production-url.com
    
    steps:
      - name: Wait for approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: ${{ vars.PROD_APPROVERS || github.repository_owner }}
          minimum-approvals: 1
          issue-title: "Production Deployment Approval Required"
          issue-body: |
            **Production Deployment Request**
            
            ðŸš€ **Tag to deploy:** `${{ github.event.inputs.tag }}`
            ðŸŽ¯ **Environment:** Production
            ðŸ‘¤ **Requested by:** @${{ github.actor }}
            ðŸ“… **Requested at:** ${{ github.event.head_commit.timestamp }}
            
            **Please review and approve this production deployment.**
            
            ### Pre-deployment Checklist:
            - [ ] Tag has been tested in UAT environment
            - [ ] All tests are passing
            - [ ] Documentation is updated
            - [ ] Rollback plan is prepared
            
            **To approve:** Comment `approved` or `approve`
            **To reject:** Comment `denied` or `reject`

      - name: Checkout code for the given tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Display deployment context
        run: |
          echo "Selected environment: prod"
          echo "Tag to deploy: ${{ github.event.inputs.tag }}"

      # Retrieve ENV_NAME variable configured in GitHub Environment
      - name: Show environment variable from GitHub Environment
        run: |
          echo "ENV_NAME from prod environment is: ${{ vars.ENV_NAME }}"

      - name: Deploy to Production
        run: |
          echo "Deploying ${{ github.event.inputs.tag }} to Production environment..."
          # Add your production deployment commands here

      - name: Post-deployment notification
        run: |
          echo "âœ… Successfully deployed ${{ github.event.inputs.tag }} to Production!"
          echo "ðŸ”— Production URL: https://your-production-url.com"
