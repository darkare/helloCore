name: Post-Deployment Tests
# ‚úÖ This workflow is triggered by another workflow ('Manual Deploy by Tag') and receives inputs from it.
run-name: "Post-Deployment Tests for ${{ github.event.inputs.environment }}"

on:
  # This allows the workflow to be triggered by the 'tag.yml' workflow.
  workflow_dispatch:
    inputs:
      environment:
        description: 'The environment (e.g., uat, prod)'
        required: true
      tag:
        description: 'The git tag being deployed'
        required: true
      head_sha:
        description: 'The commit SHA to checkout'
        required: true

jobs:
  run-postman-tests:
    name: Run Postman Tests
    runs-on: ubuntu-latest
    # üîê Granting permissions for the job to read contents and write to releases.
    permissions:
      contents: write
    steps:
      - name: "üì• Get data from inputs"
        id: get_data
        run: |
          ENV="${{ github.event.inputs.environment }}"
          TAG="${{ github.event.inputs.tag }}"
          
          if [ "$ENV" = "uat" ]; then
            URL_DOMAIN="https://uat.mamamia.com.au"
          elif [ "$ENV" = "prod" ]; then
            URL_DOMAIN="https://www.mamamia.com.au"
          else
            echo "‚ùå Could not determine a valid environment from input."
            exit 1
          fi
          
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "url_domain=$URL_DOMAIN" >> $GITHUB_OUTPUT

      - name: "Checkout code for tag: ${{ github.event.inputs.tag }}"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.head_sha }}

      - name: "Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: "Install Postman CLI"
        run: |
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh

      - name: "‚ñ∂Ô∏è Run API Tests (mm-api-test)"
        run: |
          postman collection run postman/mm-api-test.postman_collection.json \
              --env-var URL_DOMAIN=${{ steps.get_data.outputs.url_domain }} \
              --reporters cli,html,json --reporter-html-export ${{ steps.get_data.outputs.environment }}-mm-api-test-report.html \
              --reporter-json-omitAllHeadersAndBody \
              --reporter-json-export ${{ steps.get_data.outputs.environment }}-mm-api-test-report.json || true
          
      - name: "‚ñ∂Ô∏è Run Page Tests (mm-page-test)"
        run: |
          postman collection run postman/mm-page-test.postman_collection.json \
            --env-var URL_DOMAIN=${{ steps.get_data.outputs.url_domain }} \
            --reporters cli,html,json --reporter-html-export ${{ steps.get_data.outputs.environment }}-mm-page-test-report.html \
            --reporter-json-omitAllHeadersAndBody \
            --reporter-json-export ${{ steps.get_data.outputs.environment }}-mm-page-test-report.json || true

      - name: "Debug: List files in workspace"
        run: |
          ls -R

      - name: "üìé Attach Report & Update Release Notes"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TZ: Australia/Sydney
        run: |
          TAG=${{ steps.get_data.outputs.tag }}
          ENV=${{ steps.get_data.outputs.environment }}
          NOW=$(date +"%Y-%m-%d %H:%M:%S %Z")

          if ! release_json=$(gh api repos/${{ github.repository }}/releases/tags/$TAG 2>/dev/null); then
            echo "‚ÑπÔ∏è No release found for tag $TAG. Skipping report processing."
            exit 0
          fi
          
          echo "‚úÖ Release found for tag $TAG. Processing test reports."
          
          gh release upload $TAG ./${{ steps.get_data.outputs.environment }}-mm-page-test-report.html --clobber
          gh release upload $TAG ./${{ steps.get_data.outputs.environment }}-mm-api-test-report.html --clobber
          
          release_id=$(echo "$release_json" | jq -r .id)
          current_body=$(echo "$release_json" | jq -r .body)

          if [ -f ${{ steps.get_data.outputs.environment }}-mm-page-test-report.json ]; then
            MM_PAGES_TOTAL_TESTS=$(jq '.run.summary.tests.executed' ${{ steps.get_data.outputs.environment }}-mm-page-test-report.json)
            MM_PAGES_FAILED_TESTS=$(jq '.run.summary.tests.failed'   ${{ steps.get_data.outputs.environment }}-mm-page-test-report.json)
            MM_PAGES_PASSED_TESTS=$(jq '.run.summary.tests.passed'   ${{ steps.get_data.outputs.environment }}-mm-page-test-report.json)
          else
            MM_PAGES_TOTAL_TESTS=0; MM_PAGES_FAILED_TESTS=0; MM_PAGES_PASSED_TESTS=0
          fi

          if [ -f ${{ steps.get_data.outputs.environment }}-mm-api-test-report.json ]; then
            MM_API_TOTAL_TESTS=$(jq '.run.summary.tests.executed' ${{ steps.get_data.outputs.environment }}-mm-api-test-report.json)
            MM_API_FAILED_TESTS=$(jq '.run.summary.tests.failed'   ${{ steps.get_data.outputs.environment }}-mm-api-test-report.json)
            MM_API_PASSED_TESTS=$(jq '.run.summary.tests.passed'   ${{ steps.get_data.outputs.environment }}-mm-api-test-report.json)
          else
            MM_API_TOTAL_TESTS=0; MM_API_FAILED_TESTS=0; MM_API_PASSED_TESTS=0
          fi

          if [ -n "$MM_PAGES_FAILED_TESTS" ] && [ "$MM_PAGES_FAILED_TESTS" -gt 0 ]; then
            SUMMARY_BODY_PAGES="**‚ùå MM-PAGES test failed! : TOTAL ${MM_PAGES_TOTAL_TESTS} PASSED ${MM_PAGES_PASSED_TESTS} FAILED ${MM_PAGES_FAILED_TESTS}"
          else
            SUMMARY_BODY_PAGES="**‚úÖ MM-PAGES test passed! : TOTAL ${MM_PAGES_TOTAL_TESTS} PASSED ${MM_PAGES_PASSED_TESTS} FAILED ${MM_PAGES_FAILED_TESTS}"
          fi

          if [ -n "$MM_API_FAILED_TESTS" ] && [ "$MM_API_FAILED_TESTS" -gt 0 ]; then
            SUMMARY_BODY_API="**‚ùå MM-API test failed!: TOTAL ${MM_API_TOTAL_TESTS} PASSED ${MM_API_PASSED_TESTS} FAILED ${MM_API_FAILED_TESTS}"
          else
            SUMMARY_BODY_API="**‚úÖ MM-API test passed! : TOTAL ${MM_API_TOTAL_TESTS} PASSED ${MM_API_PASSED_TESTS} FAILED ${MM_API_FAILED_TESTS}"
          fi

          new_entry=$(cat <<EOF

          ---
          ### ü§ñ Post-Deployment Test Results
          <small>
          - **Environment:** ${ENV^^}
          - **Test Date:** ${NOW}
          - **Workflow Run:** [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          </small>

          - ${SUMMARY_BODY_PAGES}
          - ${SUMMARY_BODY_API}
          EOF
          )

          # Append the new entry to the current body
          updated_body="${current_body}${new_entry}"

          # Update the release notes
          gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/releases/$release_id \
            -f body="$updated_body"

          echo "‚úÖ Attached Postman test reports and updated release notes for $TAG."
